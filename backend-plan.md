# Mastra Agent 在 Cloudflare Workers 上的设计与实现

## 项目架构设计

### 核心组件

1. **Mastra Agent**: 主 agent，负责协调工具调用和生成响应
2. **Tools**: 三个核心工具

   - `dateWeatherTool`: 查询中国天气和日期信息
   - `sportsVenueTool`: 查询美团/大众点评的运动场馆信息
   - `travelPlanTool`: 查询旅游信息、地图信息，制定周末旅游计划

3. **CloudflareDeployer**: 自动部署配置

### 技术栈

- **框架**: Mastra (@mastra/core)
- **部署**: @mastra/deployer-cloudflare
- **LLM**: OpenAI 或 Anthropic
- **运行时**: Cloudflare Workers

## 实施步骤

### 1. 安装依赖

- 安装 `@mastra/core`、`@mastra/deployer-cloudflare`
- 安装 LLM SDK (`@ai-sdk/openai` 或 `@ai-sdk/anthropic`)
- 安装 `zod` 用于 schema 验证

### 2. 创建项目结构

```
src/
├── mastra/
│   ├── agents/
│   │   └── weekend-planner-agent.ts
│   ├── tools/
│   │   ├── date-weather-tool.ts
│   │   ├── sports-venue-tool.ts
│   │   └── travel-plan-tool.ts
│   └── index.ts
├── index.ts (Worker 入口)
└── types.ts
```

### 3. 实现 Tools

#### date-weather-tool.ts

- 使用中国天气 API（如和风天气、心知天气等）
- 输入：城市名称、日期
- 输出：天气信息、日期信息

#### sports-venue-tool.ts

- 集成美团/大众点评 API 或使用网页爬取
- 输入：城市、运动类型、位置
- 输出：场馆列表（名称、地址、评分、营业时间）

#### travel-plan-tool.ts

- 集成地图 API（高德地图、百度地图）
- 集成旅游信息 API
- 输入：出发地、目的地、日期、偏好
- 输出：旅游计划（路线、景点、时间安排）

### 4. 创建 Agent

- 配置 agent 的 instructions，明确其职责
- 关联所有三个工具
- 配置 LLM（OpenAI 或 Anthropic）

### 5. 配置 Mastra

- 在 `src/mastra/index.ts` 中初始化 Mastra 实例
- 注册 agent 和 tools
- 配置 CloudflareDeployer

### 6. 更新 Worker 入口

- 修改 `src/index.ts` 以使用 Mastra agent
- 创建 `/api/chat` 端点处理请求
- 支持流式响应

### 7. 配置环境变量

- 更新 `wrangler.jsonc` 添加环境变量绑定
- 创建 `.dev.vars` 用于本地开发
- 配置 API keys（OpenAI/Anthropic、天气 API、地图 API）

### 8. 更新配置文件

- 更新 `package.json` 添加依赖和脚本
- 更新 `tsconfig.json` 确保类型支持
- 配置 `wrangler.jsonc` 的兼容性标志

## 关键文件修改

### src/mastra/index.ts

- 初始化 Mastra，注册 agent
- 配置 CloudflareDeployer

### src/index.ts

- 替换现有的 Workers AI 调用
- 使用 Mastra agent 处理请求
- 保持流式响应支持

### package.json

- 添加 Mastra 相关依赖
- 更新构建脚本

### wrangler.jsonc

- 配置环境变量
- 确保 nodejs_compat 标志

## API 设计

### POST /api/chat

请求体：

```json
{
  "messages": [
    {"role": "user", "content": "帮我制定这周末去北京的旅游计划"}
  ]
}
```

响应：流式返回 agent 的回复

## 测试用例设计（使用杭州作为测试城市）

### 1. 日期和天气查询功能测试

#### 测试用例 1.1: 查询当前日期和天气

- **输入**: "今天杭州的天气怎么样？"
- **预期输出**: 返回当前日期和杭州的实时天气信息（温度、湿度、风力、天气状况）

#### 测试用例 1.2: 查询未来日期天气

- **输入**: "这周六杭州的天气如何？"
- **预期输出**: 返回周六的日期和杭州的天气预报

#### 测试用例 1.3: 查询周末天气

- **输入**: "这个周末杭州的天气情况"
- **预期输出**: 返回周六和周日的天气信息

#### 测试用例 1.4: 查询特定日期范围

- **输入**: "下周末（3月15-16日）杭州的天气"
- **预期输出**: 返回指定日期范围的天气信息

### 2. 运动场馆查询功能测试

#### 测试用例 2.1: 查询篮球场馆

- **输入**: "帮我找一下杭州适合周末打篮球的场馆"
- **预期输出**: 返回杭州的篮球场馆列表（名称、地址、评分、营业时间、价格）

#### 测试用例 2.2: 查询游泳场馆

- **输入**: "杭州有哪些周末可以游泳的地方？"
- **预期输出**: 返回杭州的游泳馆列表

#### 测试用例 2.3: 查询羽毛球场馆

- **输入**: "推荐几个杭州周末打羽毛球的场馆"
- **预期输出**: 返回羽毛球馆列表，包含位置和评分信息

#### 测试用例 2.4: 按区域查询运动场馆

- **输入**: "西湖区附近有什么运动场馆适合周末去？"
- **预期输出**: 返回西湖区附近的运动场馆列表

#### 测试用例 2.5: 查询综合运动场馆

- **输入**: "杭州有哪些综合性的运动场馆，适合周末运动？"
- **预期输出**: 返回包含多种运动项目的场馆列表

### 3. 旅游计划制定功能测试

#### 测试用例 3.1: 制定一日游计划

- **输入**: "帮我制定这周末杭州的一日游计划"
- **预期输出**: 返回包含景点、路线、时间安排的详细计划

#### 测试用例 3.2: 制定两日游计划

- **输入**: "制定一个杭州周末两日游的行程"
- **预期输出**: 返回两天的详细行程安排，包括景点、路线、住宿建议

#### 测试用例 3.3: 主题旅游计划

- **输入**: "我想这周末去杭州，主要想看看西湖和灵隐寺，帮我规划一下"
- **预期输出**: 返回围绕指定景点的旅游计划，包含路线和最佳游览时间

#### 测试用例 3.4: 带运动元素的旅游计划

- **输入**: "周末去杭州，想上午运动，下午游览，帮我安排一下"
- **预期输出**: 返回结合运动场馆和旅游景点的综合计划

#### 测试用例 3.5: 多景点路线规划

- **输入**: "这周末去杭州，想去西湖、雷峰塔、宋城，帮我规划最优路线"
- **预期输出**: 返回最优路线规划，包含交通方式和时间安排

#### 测试用例 3.6: 实时交通信息

- **输入**: "这周末从杭州东站到西湖怎么走最快？"
- **预期输出**: 返回实时交通路线，包含多种交通方式（地铁、公交、打车）和时间预估

### 4. 综合功能测试

#### 测试用例 4.1: 完整周末规划

- **输入**: "帮我制定这周末在杭州的完整计划，包括天气、运动和旅游"
- **预期输出**: 返回包含天气信息、运动场馆推荐和旅游计划的综合方案

#### 测试用例 4.2: 基于天气的智能推荐

- **输入**: "如果这周末杭州下雨，帮我重新规划一下活动"
- **预期输出**: 根据天气情况调整计划，推荐室内活动或替代方案

#### 测试用例 4.3: 多天综合规划

- **输入**: "帮我规划这周末在杭州的两天，要包括运动、游览和美食"
- **预期输出**: 返回两天的综合计划，包含运动场馆、旅游景点和美食推荐

## 测试实施

### 测试文件结构

```
src/
├── mastra/
│   └── __tests__/
│       ├── date-weather-tool.test.ts
│       ├── sports-venue-tool.test.ts
│       ├── travel-plan-tool.test.ts
│       └── weekend-planner-agent.test.ts
└── test/
    └── integration/
        └── api.test.ts
```

### 测试工具

- 使用 Vitest 进行单元测试
- 使用 Cloudflare Workers 测试环境进行集成测试

## 环境变量配置

### OpenAI API Key

- **已配置**: OpenAI API key 已存在于 `.env` 文件中
- **读取方式**: 在代码中使用 `process.env.OPENAI_API_KEY` 读取
- **部署配置**: 需要在 `wrangler.jsonc` 中配置环境变量绑定，或使用 `wrangler secret put OPENAI_API_KEY` 设置

### 其他 API Keys

- 天气 API key（如和风天气、心知天气）
- 地图 API key（高德地图或百度地图）
- 美团/大众点评 API key（如需要）

### 本地开发

- 使用 `.dev.vars` 文件存储本地开发环境变量
- 从 `.env` 文件同步配置到 `.dev.vars`
- 确保 `.env` 和 `.dev.vars` 都在 `.gitignore` 中

## 注意事项

1. **API 限制**: 美团/大众点评可能需要使用官方 API 或网页爬取，注意遵守使用条款
2. **天气 API**: 选择支持中国城市的天气服务（推荐：和风天气、心知天气）
3. **地图 API**: 高德地图或百度地图需要申请 API key
4. **错误处理**: 每个 tool 需要完善的错误处理
5. **流式响应**: 确保 Mastra agent 的流式响应正确传递到客户端
6. **测试数据**: 使用杭州的真实数据进行测试，确保 API 返回结果的准确性
7. **API 配额**: 注意各 API 服务的调用限制，测试时合理使用
8. **密钥安全**: 确保 `.env` 文件不被提交到版本控制系统，使用 Cloudflare Workers 的 secrets 功能管理生产环境密钥